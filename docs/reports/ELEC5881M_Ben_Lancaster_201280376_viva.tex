\documentclass[aspectratio=169]{beamer}

%https://en.wikibooks.org/wiki/LaTeX/Presentations
%\AtBeginSection[]{\subsection{}}
%\beamertemplatenavigationsymbolsempty

%\usetheme{Singapore}
%\usetheme{Rochester}
%\usetheme{JD}
%\usetheme{PaloAlto}
%\usetheme{Copenhagen}
%\usecolortheme{orchid}
%\usecolortheme{whale}

%\usecolortheme{Antibes}
%\usetheme{Rochester}
\usecolortheme{orchid}
\useoutertheme[hideothersubsections]{sidebar}
\setbeamertemplate{itemize items}[circle]
\setbeamertemplate{section in toc}[circle]

\setbeamertemplate{frametitle}{\vspace{-1cm}{\usebeamercolor[fg]{structure}\bfseries\insertframetitle}}

\beamertemplatenavigationsymbolsempty


\usepackage{helvet}
\usepackage{hyperref}
\definecolor{eclipseBlue}{RGB}{42,0.0,255}
\definecolor{eclipseGreen}{RGB}{63,127,95}
\definecolor{eclipsePurple}{RGB}{127,0,85}

\usepackage{listings}
\lstset{basicstyle=\scriptsize\ttfamily}
\lstset{escapeinside={<@}{@>}}
\lstdefinelanguage{myLang}
{
  % list of keywords
  keywords = {},
  keywords = [1]{
    movi,
    lw,
    cmp,
    addi,
    mov, jmp, br,
    nop, halt, intr,
  },
  keywords = [2]{
    r0, r1, r2, r3, r4, r5, r6, r7
  },
  keywords = [3]{
    BR_E, BR_NE, BR_L, BR_G, BR_U
  },
  keywords = [4]{
    lwex, swex,
  },
  keywordstyle=[1]\color{eclipsePurple},
  keywordstyle=[4]\bfseries\color{eclipsePurple},
  keywordstyle=[2]\color{eclipseBlue},
  keywordstyle=[3]\color{red},
  sensitive=false,
  morecomment=[l]{//}, % l is for line comment
  morestring=[b]",
  otherkeywords={
    movi
  },
}


\lstset{
    language=myLang,
    commentstyle=\color{eclipseGreen},
    %keywordstyle=\color{eclipseBlue},
    %stringstyle=\color{eclipsePurple},
}


\title
    [Main Project]
    {\textbf{Multi-core RISC SoC Design \& Implementation}}
\subtitle{Demonstration Viva}

\author
    [B. Lancaster]
    {Ben Lancaster}
\institute
    [\hypersetup{urlcolor=jdgrey}%
     \href{https://bendl.me/}{https://bendl.me}
    ]
    {201280376\\
    ELEC5881M - Main Project}
\date
    {\today}

\newcommand\pro{\item[$+$]}
\newcommand\con{\item[$-$]}

\begin{document}

\begin{frame}[plain]
\titlepage
\end{frame}

\begin{frame}{Quick Links}
\begin{itemize}\setlength\itemsep{1em}
    \item GitHub repository: \url{https://github.com/bendl/vmicro16}
    \item Full Report: \url{https://github.com/bendl/vmicro16/blob/master/docs/reports/build/ELEC5881M_Ben_Lancaster_201280376_Final.pdf}
    \item This presentation: \url{https://github.com/bendl/vmicro16/blob/master/docs/reports/build/ELEC5881M_Ben_Lancaster_201280376_viva.pdf}
    \item About me: \color{blue}{\url{https://bendl.me/}}
\end{itemize}
\end{frame}

\begin{frame}
\vspace{-1cm}
\begin{columns}[t]
        \begin{column}{.3\textwidth}
            \tableofcontents[sections={1-3},subsectionstyle=show/show/hide]
        \end{column}
        \begin{column}{.3\textwidth}
            \tableofcontents[sections={4-6},subsectionstyle=show/show/hide]
        \end{column}
    \end{columns}
\end{frame}

\section{Introduction}
\frame{\vspace{-1cm}\tableofcontents[currentsection, subsectionstyle=show/show/hide]}

\subsection{Why a project on CPUs?}
\begin{frame}{Why a project on CPUs?}
\begin{itemize}\setlength\itemsep{1em}
    \item{\textbf{CPUs will be used for the rest of humanity}}
    \item{\textbf{Understand design constraints and considerations}}
    \item{\textbf{Prepare myself for future employment/work}}
\end{itemize}
\end{frame}

\subsection{Why Multi-core?}
\begin{frame}{Why Multi-core?}

\begin{itemize}\setlength\itemsep{1em}
    \item{\textbf{Rate of single-core speed improvements slowing}}
    \item{\textbf{Future of computing = parallel}}
\end{itemize}
\end{frame}

\subsection{Why RISC?}
\begin{frame}{Why RISC?}
\begin{itemize}\setlength\itemsep{1em}
    \item Simpler design \& impl
    \item Smaller = fit more cores on a chip
    \item Previous experience + future work
    \item I'm a RISC purist
\end{itemize}
\end{frame}

\section{Top Level Design}
\frame{\vspace{-1cm}
\tableofcontents[currentsection, subsectionstyle=show/show/hide]}

\subsection{Overview}
\begin{frame}{Overview}
What this project produces:
\begin{itemize}\setlength\itemsep{1em}
    \item{System-on-Chip with multi-processor functionality\\
    %Tested on FPGA hardware with 1-96 CPU cores.
    }
    
    \item{Custom 16-bit RISC CPU\\
    %With interrupts and its own Instruction Set Architecture (ISA).
    }
    
    \item{Software/Assembly compiler\\
    %PRCO304 programming language/Intel assembly syntax.
    }
    
    \item{Aimed at Design Engineers, not end users\\
    %Project is provided as source code/design files for Design Engineers to customise and implement in hardware themselves.
    }
\end{itemize}
\end{frame}

\begin{frame}{Top Level Hierarchy}
\vspace{-.3cm}
\begin{figure}
\includegraphics[width=7.5cm]{soc_layout_schem}
\end{figure}
\end{frame}

\subsection{Memory Map}
\begin{frame}{Memory Map}
\begin{columns}
\column{0.5\textwidth}
\begin{figure}
\includegraphics[width=4cm]{memory_map}
\end{figure}
\column{0.5\textwidth}
\begin{itemize}
    \item \textbf{Shared Memory*}
    \item Timer + interrupts
    \item UART send/receive 
    \item GPIO
    \item Scratch memory
    \item Extra registers
    \item + more
\end{itemize}
\end{columns}
\end{frame}

\subsection{Interconnect}
\begin{frame}{Interconnect}
\begin{columns}[t]
\column{0.5\textwidth}
\begin{itemize}
    \item AMBA APB Bus
    \item Tristate \& Non-tristate (mux) impl
    \item Originally Wishbone, now APB
    \item AHB too complex (limited time)
    \item Various schedulers
\end{itemize}
\column{0.5\textwidth}
\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{interconnold}
    \caption{Vmicro16 interconnect}
    \label{fig:my_label}
\end{figure}
\end{columns}
\end{frame}

\begin{frame}{Interconnect Schematic}
    \begin{figure}
        \centering
        \includegraphics[width=0.6\textwidth]{ahb}
        \caption{Source: ARM AHB-Lite Protocol Specification Figure 4-2.}
        \label{fig:my_label}
    \end{figure}
\end{frame}

\subsection{ISA}
\begin{frame}{Instruction Set Architecture}
    
\begin{columns}[t]
\column{0.5\textwidth}
\begin{itemize}
    \pro 16-bits, 38 instructions
    \pro Simple load/store arch
    \pro (Un)signed instructions
    \pro Compact
    \pro Optional hardware multiply instruction\\
    
    \con Only 8 registers
    \con No good compiler support
\end{itemize}
\column{0.5\textwidth}
\vspace{-2cm}
\begin{figure}
    \centering
    \includegraphics[width=5.5cm]{isa2}
\end{figure}
\end{columns}
\end{frame}

\subsection{Interrupts}
\begin{frame}[c]
\begin{center}
\Huge SW Example
\end{center}
\end{frame}

\iffalse
\begin{frame}[t]{Interrupts}
\begin{columns}[t]
\column{0.5\textwidth}
\begin{figure}
\includegraphics[width=\textwidth]{rinterrupts}\\
\vspace{.5cm}
\includegraphics[width=\textwidth]{rinterruptsmask}
\end{figure}
\column{0.5\textwidth}
\begin{figure}
\includegraphics[width=\textwidth]{vinterrupts}
\end{figure}
\end{columns}
\vspace{1cm}
Demo: 2 Core LED toggle (GPIO0) with TIMR0 1s interrupt (interrupts\_2.s)
\end{frame}
\fi

\begin{frame}{Timer Interrupt Example}
    \begin{figure}
        \centering
        \includegraphics[width=0.9\textwidth]{interrupts}
    \end{figure}
    Demo: 2 Core LED toggle (GPIO0) with TIMR0 1s interrupt (interrupts\_2.s)
\end{frame}

\iffalse
\begin{frame}{Timer Peripheral Registers}
    \begin{figure}
        \centering
        \includegraphics[width=0.9\textwidth]{rtimer}
        \caption{$t = 20{ns} * {load} * {prescaler}$}
        \label{}
    \end{figure}
    Resolution (32-bit timer): 20ns to 85s.
    
    Examples: 
    \begin{itemize}
        \item For 1us: Load = 0x32, Prescaler = 0 (20ns * 0x32 = 1000ns)
        \item For 1s:  Load = 0x1000, Prescaler = 0x3000 (demo)\\(20ns * 0x1000 * 0x3000 = approx. 1s)
    \end{itemize}
\end{frame}
\fi

\section{Multi-core Functionality}
\frame{\vspace{-1cm}\tableofcontents[currentsection, subsectionstyle=show/show/hide]}
\subsection{HW/SW Requirements}
\begin{frame}{HW/SW Requirements}
\begin{columns}[t]
\column{0.5\textwidth}
Hardware:
\begin{itemize}[<+->]
    \item \textbf{Bus Arbitration}\\ (scheduling: priority, rotating, etc.)
    \item \textbf{Atomic functions}\\ (atomic versions of load/store to prevent race conditions)
    \item Per-core instruction memory
    \item Per-core context-switching for interrupt handling
\end{itemize}
\column{0.5\textwidth}
Software:
\begin{itemize}[<+->]
    \item \textbf{Semaphores/Mutexes}\\ (exclusive memory access)
    \item \textbf{Thread synchronisation}\\ (memory barriers)
    \item \textbf{Context identification}\\ What core am I?\\ How many cores?\\ How much memory?
\end{itemize}
\end{columns}
\end{frame}

\subsection{Context Identification}
\begin{frame}[fragile]{Context Identification}
\begin{columns}
\column{0.5\textwidth}
\begin{figure}
\includegraphics[width=\textwidth]{sregs}
\caption{Special Registers 0x0080 to 0x008F}
\end{figure}
\column{0.5\textwidth}
\begin{lstlisting}
entry:
    // get core idx 0x80 in r7
    movi    r7, #0x80
    lw      r7, r7

    // Branch away if not core 0
    cmp     r7, r0
    movi    r0, exit
    br      r0, BR_NE 
    
    // Core 0 only instructions
    nop
    nop
    nop
    
exit:
    halt  
\end{lstlisting}
\end{columns}
\end{frame}


\subsection{Atomics}
\begin{frame}[fragile]{Atomic Instructions}
\begin{columns}[t]
\column{0.5\textwidth}
\begin{itemize}\setlength{\itemsep 1em}
    \item Enables semaphores, mutexes, memory barriers
    \item Prevent race conditions between threads/cores
    \item LW[EX] and SW[EX]
    \item Implementation in next slide
\end{itemize}
\column{0.5\textwidth}
\begin{lstlisting}[basicstyle=\scriptsize\ttfamily]
try_inc:
    // load and lock
    // (if not already locked)
    lwex    r0, r1
    // do something
    // (i.e. add 1 (semaphore))
    addi    r0, #0x01
    // attempt store
    swex    r0, r1
    
    // check success (== 0)
    cmp     r0, r3
    
    // if not equal (NE), retry
    movi    r4, try_inc
    br      r4, BR_NE
    
critical:
    // r0 is latest value
\end{lstlisting}
\end{columns}
\end{frame}

\begin{frame}{Exclusive Access Flow Chart}
    \begin{figure}
        \centering
        \includegraphics[width=0.7\textwidth]{semaphore}
    \end{figure}
\end{frame}

\begin{frame}{HW - How do I know which core this lwex/swex is from?}
    \begin{figure}
        \centering
        \includegraphics[width=0.8\textwidth]{coreid}
    \end{figure}
    The Core Idx is sent with each MMU request to the shared bus.\\
    \begin{figure}
        \centering
        \includegraphics[width=0.8\textwidth]{apb_paddr}
    \end{figure}
    PADDR*NUMCORES-1:0 interconnect input.
\end{frame}

\begin{frame}[fragile]{Exclusive Access}

\begin{columns}[t]
\column{0.3\textwidth}
\begin{lstlisting}[basicstyle=\tiny\ttfamily]
mutex_claim:
    // load and lock
    // (if not already locked)
    lwex    r0, r1
    // do something
    // (i.e. add 1 (semaphore))
    addi    r0, #0x01
    // attempt store
    swex    r0, r1
    
    // check success (== 0)
    cmp     r0, r3
    
    // if not equal (NE), retry
    movi    r4, mutex_claim
    br      r4, BR_NE
    
critical:
    nop
    
\end{lstlisting}

\column{0.7\textwidth}
\vspace{-1cm}
\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{bram_ex}
    \caption{HW impl}
    \label{}
\end{figure}
\end{columns}
Demo: 8 core number summation (sum.s)
\end{frame}

\subsection{Design Challenges}
\begin{frame}[fragile,t]{Design Challenges}
\begin{columns}[t]
\column{0.5\textwidth}
\textbf{Memory Limitations}\\
\vspace{0.5cm}
Each core has it's own instruction memory
\begin{itemize}
    \pro Fast fetching and branching
    \con Requires a dedicated BRAM (FPGA) per core
    \con Limited BRAM blocks available
    \con \textbf{Reduces maximum core count}
\end{itemize}
\column{0.5\textwidth}
\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{bram_limit}
\end{figure}
\end{columns}
\end{frame}

\begin{frame}[fragile,t]{Design Challenges}
\begin{columns}
\column{0.5\textwidth}
\textbf{Memory Limitations - Solution}\\
\vspace{0.5cm}
Global instruction ROM
\begin{itemize}
    \pro Single BRAM
    \pro Smaller core size
    \con \textbf{Slow access times}
    \pro \textbf{Increases maximum core count}
\end{itemize}
\column{0.5\textwidth}
\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{bram_limit_sol}
\end{figure}
\end{columns}
\end{frame}

\section{Results}
\frame{\tableofcontents[currentsection, subsectionstyle=show/show/hide]}

\subsection{Summation}
\begin{frame}{Summation - Multi-core vs Single-Core}
\begin{itemize}\setlength{\itemsep 2em}
    \item Each core has low work load
        \begin{itemize}
            \item Sum subset of numbers in for loop
        \end{itemize}
    \item Ideal scenario for parallelism
    \begin{itemize}
        \item Highly parallelisable
        \item Few inter-thread dependencies
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}{Summation - Multi-core vs Single-Core}
240 samples (@30 cores = 8 samples per core)
\begin{figure}
    \centering
    \includegraphics[width=0.7\textwidth]{alg_time}
\end{figure}
\end{frame}

\subsection{Summation - Shared Instruction ROM}
\begin{frame}{Multi-core vs Single-Core for Summation}
240 samples (@30 cores = 8 samples per core)
\begin{figure}
    \centering
    \includegraphics[width=0.7\textwidth]{alg_time}
\end{figure}
\end{frame}


\section{Conclusion}
\frame{\tableofcontents[currentsection, subsectionstyle=show/show/hide]}

\subsection{Accomplishments}
\begin{frame}{Accomplishments}
\begin{itemize}\setlength{\itemsep 1em}
    \item \textbf{System-on-Chip with peripherals}\\
    Timers, GPIO, UART, Registers, Memory
    
    \item \textbf{Common multi-thread/core synchronisation primitives}\\
    Semaphores, Mutexes, Memory Barriers, Atomic Instructions
    
    \item \textbf{AMBA APB bus interconnects}
    
    \item \textbf{Interrupts with hardware context-switching}
    
    \item \textbf{Understanding of limitations and solutions}
\end{itemize}
\end{frame}

\subsection{Future Improvements}
\begin{frame}{Future Improvements}

\begin{itemize}\setlength{\itemsep 1em}
    \item \textbf{Global Reset}
    
    \item \textbf{On-chip Programming}
    
    \item \textbf{Per-core gating/enabling}
    
    \item \textbf{Improve memory bottleneck}
\end{itemize}
\end{frame}

\subsection{Q\&A}
\begin{frame}[c]
\begin{center}
\Huge Q\&A
\end{center}

\end{frame}

\begin{frame}[fragile]{Q\&A}
\begin{itemize}\setlength{\itemsep 1em}
    \item GitHub repository: \url{https://github.com/bendl/vmicro16}
    \item Full Report: \url{https://github.com/bendl/vmicro16/blob/master/docs/reports/build/ELEC5881M_Ben_Lancaster_201280376_Final.pdf}
    \item Presentation tools:
    \begin{itemize}\setlength{\itemsep 1em}
        \item Latex Beamer
        \item \verb|\usecolortheme{orchid}|
        \item \verb|\useoutertheme[hideothersubsections]{sidebar}|
    \end{itemize}
\end{itemize}
\end{frame}

\end{document}
